# 認証サービス テスト仕様書

## テストファイル構成

### User CRUD テスト

テストは以下の 3 つのファイルに分かれています：

- `test_user_normal.py`: 正常系テスト
- `test_user_error.py`: 異常系テスト
- `test_user_boundary.py`: 境界値テスト

### セキュリティ機能テスト

セキュリティ関連のテストは以下の 3 つのファイルに分かれています：

- `test_security_normal.py`: 正常系テスト
- `test_security_boundary.py`: 境界値テスト
- `test_security_error.py`: 異常系テスト

## テストケース一覧

### 正常系テスト (`test_user_normal.py`)

| テスト関数                         | テスト内容                   | 主なアサーション                                                                                |
| ---------------------------------- | ---------------------------- | ----------------------------------------------------------------------------------------------- |
| `test_create_user`                 | ユーザー作成の基本機能       | - ID が生成されていること<br>- ユーザー名が正しいこと<br>- パスワードがハッシュ化されていること |
| `test_get_user_by_id_exists`       | ID によるユーザー取得        | - ユーザーが取得できること<br>- 取得したユーザーの情報が正しいこと                              |
| `test_get_user_by_username_exists` | ユーザー名によるユーザー取得 | - ユーザーが取得できること<br>- 取得したユーザーの情報が正しいこと                              |
| `test_update_username`             | ユーザー名の更新             | - 更新後のユーザー名が正しいこと<br>- DB に反映されていること                                   |
| `test_update_password`             | パスワードの更新             | - 新しいパスワードで認証できること<br>- 古いパスワードで認証できないこと                        |
| `test_delete_user`                 | ユーザーの削除               | - ユーザーが削除されていること<br>- 削除後に取得できないこと                                    |

### 異常系テスト (`test_user_error.py`)

| テスト関数                                | テスト内容                              | 期待される例外/結果 |
| ----------------------------------------- | --------------------------------------- | ------------------- |
| `test_create_user_with_empty_username`    | 空のユーザー名でのユーザー作成          | ValidationError     |
| `test_create_user_with_too_long_username` | 51 文字以上のユーザー名でのユーザー作成 | ValidationError     |
| `test_create_user_with_empty_password`    | 空のパスワードでのユーザー作成          | ValidationError     |
| `test_create_user_with_too_long_password` | 17 文字以上のパスワードでのユーザー作成 | ValidationError     |
| `test_create_duplicate_username`          | 重複するユーザー名でのユーザー作成      | IntegrityError      |
| `test_get_user_by_invalid_id`             | 無効な UUID でのユーザー取得            | StatementError      |
| `test_get_user_by_nonexistent_id`         | 存在しない ID でのユーザー取得          | None                |
| `test_get_user_by_nonexistent_username`   | 存在しないユーザー名でのユーザー取得    | None                |
| `test_update_user_with_too_long_username` | 51 文字以上のユーザー名への更新         | ValidationError     |
| `test_update_user_with_too_long_password` | 17 文字以上のパスワードへの更新         | ValidationError     |
| `test_update_to_duplicate_username`       | 重複するユーザー名への更新              | IntegrityError      |
| `test_update_nonexistent_user`            | 存在しないユーザーの更新                | Exception           |
| `test_delete_nonexistent_user`            | 存在しないユーザーの削除                | Exception           |

### 境界値テスト (`test_user_boundary.py`)

| テスト関数                                             | テスト内容                   | 検証項目                                                           |
| ------------------------------------------------------ | ---------------------------- | ------------------------------------------------------------------ |
| `test_create_user_with_minimum_length_username`        | 1 文字のユーザー名           | - ユーザーが作成できること<br>- 正しく保存されること               |
| `test_create_user_with_maximum_length_username`        | 50 文字のユーザー名          | - ユーザーが作成できること<br>- 正しく保存されること               |
| `test_create_user_with_minimum_length_password`        | 1 文字のパスワード           | - ユーザーが作成できること<br>- パスワード認証が機能すること       |
| `test_create_user_with_maximum_length_password`        | 16 文字のパスワード          | - ユーザーが作成できること<br>- パスワード認証が機能すること       |
| `test_create_user_with_special_characters_in_username` | 特殊文字を含むユーザー名     | - ユーザーが作成できること<br>- 特殊文字が正しく保存されること     |
| `test_create_user_with_unicode_characters_in_username` | Unicode 文字を含むユーザー名 | - ユーザーが作成できること<br>- Unicode 文字が正しく保存されること |

## 検証項目の詳細

### データベースの整合性

- 各操作後にデータベースの状態が期待通りであること
- トランザクションが適切に処理されること
- エラー時にロールバックが機能すること

### セキュリティ

- パスワードが適切にハッシュ化されていること
- 元のパスワードがデータベースに保存されていないこと
- パスワード認証が正しく機能すること

### バリデーション

- 入力値の長さ制限が守られていること
- 必須フィールドのチェックが機能していること
- ユニーク制約が守られていること

### エラーハンドリング

- 適切な例外が発生すること
- エラーメッセージが明確であること
- エラー時にデータベースの整合性が保たれること

## セキュリティ機能テストケース一覧

### 正常系テスト (`test_security_normal.py`)

| テスト関数                                 | テスト内容                       | 主なアサーション                                                                                |
| ------------------------------------------ | -------------------------------- | ----------------------------------------------------------------------------------------------- |
| `test_get_password_hash_success`           | パスワードのハッシュ化           | - ハッシュ化されたパスワードが元のパスワードと異なること<br>- bcrypt のプレフィックスが付くこと |
| `test_verify_password_success`             | パスワード検証                   | - 正しいパスワードで検証が成功すること<br>- 誤ったパスワードで検証が失敗すること                |
| `test_create_access_token_success`         | アクセストークン生成             | - トークンが生成されること<br>- ペイロードに正しいデータが含まれること                          |
| `test_create_access_token_with_custom_exp` | カスタム有効期限付きトークン生成 | - 指定した有効期限が設定されること                                                              |
| `test_create_refresh_token_success`        | リフレッシュトークン生成         | - トークンが生成されること<br>- Redis に保存されること<br>- 有効期限が設定されること            |
| `test_verify_refresh_token_success`        | リフレッシュトークン検証         | - 正しいユーザー ID が返されること                                                              |
| `test_revoke_refresh_token_success`        | リフレッシュトークン無効化       | - トークンが Redis から削除されること                                                           |

### 境界値テスト (`test_security_boundary.py`)

| テスト関数                                    | テスト内容                                   | 検証項目                                             |
| --------------------------------------------- | -------------------------------------------- | ---------------------------------------------------- |
| `test_create_access_token_with_min_expiry`    | 最小有効期限（1 分）でのトークン生成         | - 最小有効期限が正しく設定されること                 |
| `test_create_access_token_with_max_expiry`    | 最大有効期限（30 日）でのトークン生成        | - 最大有効期限が正しく設定されること                 |
| `test_access_token_with_large_payload`        | 大きなペイロードを持つトークン生成           | - 大きなデータを含むペイロードが正しく処理されること |
| `test_verify_password_with_min_length`        | 最小長（1 文字）のパスワード検証             | - 最小長のパスワードが検証できること                 |
| `test_verify_password_with_max_length`        | 最大長（72 文字）のパスワード検証            | - 最大長のパスワードが検証できること                 |
| `test_verify_password_with_special_chars`     | 特殊文字を含むパスワード検証                 | - 特殊文字を含むパスワードが検証できること           |
| `test_verify_password_with_unicode_chars`     | Unicode 文字を含むパスワード検証             | - Unicode 文字を含むパスワードが検証できること       |
| `test_create_refresh_token_with_long_user_id` | 長いユーザー ID でのリフレッシュトークン生成 | - 長いユーザー ID が正しく処理されること             |
| `test_verify_refresh_token_with_long_token`   | 長いトークンでのリフレッシュトークン検証     | - 長いトークンが正しく処理されること                 |
| `test_refresh_token_with_min_expiry`          | 最小有効期限でのリフレッシュトークン生成     | - 最小有効期限が正しく設定されること                 |

### 異常系テスト (`test_security_error.py`)

| テスト関数                                   | テスト内容                             | 期待される例外/結果 |
| -------------------------------------------- | -------------------------------------- | ------------------- |
| `test_verify_password_with_wrong_password`   | 誤ったパスワードでの検証               | False               |
| `test_verify_password_with_invalid_hash`     | 無効なハッシュでの検証                 | ValueError          |
| `test_decode_token_with_wrong_secret`        | 誤った秘密鍵でのトークンデコード       | JWTError            |
| `test_decode_token_with_wrong_algorithm`     | 誤ったアルゴリズムでのトークンデコード | JWTError            |
| `test_decode_expired_token`                  | 期限切れトークンのデコード             | JWTError            |
| `test_decode_invalid_token_format`           | 無効な形式のトークンデコード           | JWTError            |
| `test_verify_refresh_token_invalid`          | 無効なリフレッシュトークンの検証       | None                |
| `test_verify_refresh_token_expired`          | 期限切れリフレッシュトークンの検証     | None                |
| `test_revoke_refresh_token_not_found`        | 存在しないトークンの無効化             | False               |
| `test_redis_connection_error`                | Redis 接続エラー                       | Exception           |
| `test_create_access_token_with_invalid_data` | 無効なデータでのトークン生成           | TypeError           |

## API エンドポイントテスト

API エンドポイントのテストは、実際の HTTP リクエストを模擬して、エンドポイントの機能を検証します。

### ログインエンドポイント (`test_login.py`)

| テスト関数                    | テスト内容                             | 主なアサーション                                                                                                                        |
| ----------------------------- | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| `test_login_success`          | 正しいユーザー名とパスワードでログイン | - ステータスコードが 200 であること<br>- アクセストークンとリフレッシュトークンが返されること<br>- トークンタイプが "bearer" であること |
| `test_login_nonexistent_user` | 存在しないユーザー名でログイン         | - ステータスコードが 401 であること<br>- 適切なエラーメッセージが返されること                                                           |
| `test_login_wrong_password`   | 間違ったパスワードでログイン           | - ステータスコードが 401 であること<br>- 適切なエラーメッセージが返されること                                                           |

### ログアウトエンドポイント (`test_logout.py`)

| テスト関数                  | テスト内容                             | 主なアサーション                                                                                                                          |
| --------------------------- | -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `test_logout_success`       | 有効なリフレッシュトークンでログアウト | - ステータスコードが 200 であること<br>- 適切な成功メッセージが返されること<br>- ログアウト後のリフレッシュトークンが無効化されていること |
| `test_logout_invalid_token` | 無効なリフレッシュトークンでログアウト | - ステータスコードが 400 であること<br>- 適切なエラーメッセージが返されること                                                             |

### トークンリフレッシュエンドポイント (`test_refresh.py`)

| テスト関数                            | テスト内容                                               | 主なアサーション                                                                                                                                          |
| ------------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `test_refresh_token_success`          | 有効なリフレッシュトークンで新しいアクセストークンを取得 | - ステータスコードが 200 であること<br>- 新しいアクセストークンとリフレッシュトークンが返されること<br>- 新しいリフレッシュトークンが古いものと異なること |
| `test_refresh_token_invalid`          | 無効なリフレッシュトークンでリクエスト                   | - ステータスコードが 401 であること<br>- 適切なエラーメッセージが返されること                                                                             |
| `test_refresh_token_nonexistent_user` | ユーザーが削除された後のリフレッシュトークンでリクエスト | - このテストケースは実装が難しいため、実際のテストでは省略または特別な実装が必要                                                                          |

### ユーザー登録エンドポイント (`test_register.py`)

| テスト関数                                           | テスト内容                                                   | 主なアサーション                                                                                                                                   |
| ---------------------------------------------------- | ------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| `test_register_user_success`                         | 新規ユーザーの正常登録                                       | - ステータスコードが 200 であること<br>- 登録されたユーザー情報が正しいこと<br>- ID が UUID 形式であること<br>- is_admin フラグが False であること |
| `test_register_user_duplicate_username`              | 既存のユーザー名で登録                                       | - ステータスコードが 400 であること<br>- 適切なエラーメッセージが返されること                                                                      |
| `test_register_user_with_standard_endpoint`          | 一般登録エンドポイントを使用した登録                         | - ステータスコードが 200 であること<br>- 登録されたユーザーの is_admin フラグが False であること                                                   |
| `test_register_admin_user_by_regular_user_forbidden` | 一般ユーザーが管理者用エンドポイントにアクセス               | - ステータスコードが 403 であること<br>- 適切なエラーメッセージが返されること                                                                      |
| `test_admin_user_using_regular_endpoint`             | 管理者ユーザーが一般登録エンドポイントを使用                 | - ステータスコードが 200 であること<br>- 登録されたユーザーの is_admin フラグが False であること                                                   |
| `test_admin_user_create_admin_user`                  | 管理者ユーザーが管理者用エンドポイントで管理者ユーザーを登録 | - ステータスコードが 200 であること<br>- 登録されたユーザーの is_admin フラグが True であること                                                    |

### ユーザー削除エンドポイント (`test_delete_user.py`)

| テスト関数                               | テスト内容                                 | 主なアサーション                                                              |
| ---------------------------------------- | ------------------------------------------ | ----------------------------------------------------------------------------- |
| `test_admin_delete_user_success`         | 管理者ユーザーが他のユーザーを削除         | - ステータスコードが 204 であること<br>- レスポンスボディが空であること       |
| `test_admin_delete_self_forbidden`       | 管理者ユーザーが自分自身を削除しようとする | - ステータスコードが 400 であること<br>- 適切なエラーメッセージが返されること |
| `test_regular_user_delete_forbidden`     | 一般ユーザーがユーザー削除を試みる         | - ステータスコードが 403 であること<br>- 適切なエラーメッセージが返されること |
| `test_delete_nonexistent_user_not_found` | 存在しないユーザー ID で削除を試みる       | - ステータスコードが 404 であること<br>- 適切なエラーメッセージが返されること |

### 全ユーザー取得エンドポイント (`test_get_all_users.py`)

| テスト関数                                  | テスト内容                                       | 主なアサーション                                                                                            |
| ------------------------------------------- | ------------------------------------------------ | ----------------------------------------------------------------------------------------------------------- |
| `test_get_all_users_admin_success`          | 管理者ユーザーによる全ユーザーリスト取得         | - ステータスコードが 200 であること<br>- レスポンスがリスト形式であること<br>- 全ユーザーが含まれていること |
| `test_get_all_users_regular_user_forbidden` | 一般ユーザーによる全ユーザーリスト取得の権限確認 | - ステータスコードが 403 であること<br>- エラーメッセージが適切であること                                   |

### ユーザー更新エンドポイント (`test_update_user.py`)

| テスト関数                                      | テスト内容                                   | 主なアサーション                                                                |
| ----------------------------------------------- | -------------------------------------------- | ------------------------------------------------------------------------------- |
| `test_update_self_success`                      | ユーザーが自分自身の情報を更新               | - ステータスコードが 200 であること<br>- 更新されたユーザー情報が正しいこと     |
| `test_admin_update_other_user_success`          | 管理者が他のユーザーの情報を更新             | - ステータスコードが 200 であること<br>- 更新されたユーザー情報が正しいこと     |
| `test_admin_update_admin_flag_success`          | 管理者がユーザーの管理者フラグを変更         | - ステータスコードが 200 であること<br>- 管理者フラグが正しく更新されていること |
| `test_regular_user_update_other_user_forbidden` | 一般ユーザーが他のユーザーを更新しようとする | - ステータスコードが 403 であること<br>- 適切なエラーメッセージが返されること   |
| `test_regular_user_update_admin_flag_forbidden` | 一般ユーザーが管理者フラグを変更しようとする | - ステータスコードが 403 であること<br>- 適切なエラーメッセージが返されること   |
| `test_update_nonexistent_user_not_found`        | 存在しないユーザー ID で更新を試みる         | - ステータスコードが 404 であること<br>- 適切なエラーメッセージが返されること   |
